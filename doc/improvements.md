# Рекомендации по улучшению проекта Ogle

## Критические баги

### 1. ~~Transform::GetLocalMatrix() — некорректный кэш (Components.h)~~ ✅ Исправлено

**Проблема:** Условие кэширования проверяло `localMatrix == glm::mat4(0.0f)`, тогда как `localMatrix` инициализирован как `glm::mat4(1.0f)`. Матрица не пересчитывалась при изменении position/rotation/scale.

**Исправление:** Пересчёт по флагу `dirty`; после пересчёта `dirty = false`.

### 2. ~~Scene::UpdateTransformHierarchy — двойной обход детей (Scene.cpp)~~ ✅ Исправлено

**Проблема:** Для каждого ребёнка вызывается `UpdateTransformHierarchy(child)` дважды: внутри блока `if (bounds)` (строки 131–132) и в конце функции (строки 141–143). Лишняя рекурсия и возможные побочные эффекты.

**Исправление:** Один цикл по детям; при наличии Bounds у текущей сущности обновляется `globalRadius` после обхода каждого ребёнка.

### 3. ~~Scene::Update — view<SceneComponent> не видит Mesh (Scene.cpp)~~ ✅ Исправлено

**Проблема:** В EnTT `registry.view<SceneComponent>()` возвращает только сущности с компонентом **ровно** типа `SceneComponent`. Компонент `Mesh` хранится как `Mesh`, а не как базовый тип, поэтому сущности с `Mesh` не попадают в view, и `Update(deltaTime)` для мешей никогда не вызывается.

**Исправление:** Используется `registry.view<Mesh>()` и вызывается `mesh.Update(deltaTime)`.

### 4. ~~Scene::Initialize — replace<Bounds> (Scene.cpp)~~ ✅ Исправлено

**Проблема:** Вызов `registry.replace<Bounds>(testEntity, glm::vec3(0.0f), 0.866f)` опирается на агрегатную инициализацию. Структура `Bounds` имеет три поля (`center`, `radius`, `globalRadius`); передаются два аргумента. Лучше явно задать обновление полей.

**Исправление:** Используется `registry.get<Bounds>(testEntity)` и явное присваивание `center` и `radius`.

---

## Архитектура и консистентность

### 5. main.cpp — консоль всегда (Release тоже)

**Проблема:** `AllocConsole()`, перенаправление stdout/stderr выполняются всегда. В Release обычно консоль не нужна.

**Рекомендация:** Обернуть в `#ifdef _DEBUG` или отдельный флаг (например, `OGLE_DEBUG_CONSOLE`).

### 6. CMake — GLOB для исходников

**Проблема:** `file(GLOB_RECURSE SOURCES "src/*.cpp" "src/*.h")` не обновляет список при добавлении файлов без повторного запуска CMake.

**Рекомендация:** Либо явно перечислять исходники, либо документировать необходимость перезапуска CMake при добавлении файлов. Для больших проектов часто предпочитают явный список.

### 7. Порядок инициализации синглтонов

**Проблема:** Синглтоны (InputController, CameraManager, MaterialController, ShaderController, TextureController, UIController) с `static` внутри функции. При завершении программы порядок уничтожения не гарантирован — возможны обращения к уже уничтоженным синглтонам.

**Рекомендация:** Явно вызывать Shutdown/очистку до выхода из main; не полагаться на деструкторы синглтонов при завершении процесса.

### 8. Logger — потокобезопасность

**Проблема:** Вывод через `std::cout` без мьютекса. При логах из нескольких потоков возможен перемешанный вывод.

**Рекомендация:** Добавить мьютекс в `Logger::Log` или использовать потокобезопасный логгер (например, spdlog) при появлении многопоточности.

---

## Качество кода

### 9. Закомментированный код

**Проблема:** В Engine.cpp, RenderSystem.cpp, Scene.cpp много закомментированного кода (UIController::Get().Update, m_testCube.Update/Render, ShaderController::CheckForUpdates, фрустум-куллинг, физика).

**Рекомендация:** Удалить неиспользуемое или вынести за флаг (например, `#ifdef OGLE_LEGACY` / конфиг). Это упростит чтение и поддержку.

### 10. Жёстко заданные размеры окна

**Проблема:** В Engine::Initialize() и RenderSystem::OnResize используются магические числа 1280 и 720.

**Рекомендация:** Вынести в константы (например, в конфиг или `EngineConstants`) и использовать единое место для начального размера окна и viewport.

### 11. RenderSystem — m_renderers не используется при рендере

**Проблема:** В `Render()` цикл по `m_renderers` закомментирован; рендер идёт только через `m_scene` и `m_guiSystem`. Методы AddRenderer/RemoveRenderer работают впустую.

**Рекомендация:** Либо снова подключить рендер через `m_renderers` (если нужны дополнительные рендереры), либо убрать/упростить API и поле, чтобы не вводить в заблуждение.

### 12. Отсутствие проверок ошибок OpenGL

**Проблема:** После glGen*, glBind*, glBufferData и т.д. нет проверки ошибок (glGetError или GLAD-обёртки).

**Рекомендация:** В Debug-сборках включить проверку после критичных вызовов OpenGL или использовать расширение GL_KHR_debug для отладки.

---

## Дополнительные улучшения

### 13. Документация

- Добавить в README раздел «Сборка и запуск», зависимости, опциональные флаги.
- Указать в doc, что камера передаётся в Scene::Initialize для куллинга (сейчас IsInFrustum закомментирован).

### 14. Тесты

- Нет юнит-тестов. Для критичных модулей (ввод, математика, сериализация материалов) можно добавить тесты (Google Test, Catch2).

### 15. Конфигурация

- Размер окна, включение консоли, уровень логирования, пути к шейдерам/текстурам можно вынести в конфиг (JSON/INI) или в настройки приложения.

---

## Приоритеты

| Приоритет | Что делать |
|-----------|------------|
| Высокий   | Исправить Transform::GetLocalMatrix (кэш по dirty). |
| Высокий   | Убрать двойной вызов UpdateTransformHierarchy для детей. |
| Средний   | Заменить view<SceneComponent> на view<Mesh> (или другой способ вызова Update для мешей). |
| Средний   | Уточнить replace<Bounds> или заменить на get + присваивание. |
| Низкий    | Консоль только в Debug, почистить комментарии, вынести константы, потокобезопасный логгер при появлении потоков. |
